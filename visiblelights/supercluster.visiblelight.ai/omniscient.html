<!DOCTYPE html>
<html lang="en" style="background:#000000 !important;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omniscient App Observatory - Visible Light AI Supercluster</title>
    <link rel="stylesheet" type="text/css" href="https://supercluster.visiblelight.ai/styles.css" />
</head>
<body>
    <div
        id="vlSuperclusterRootUnset"
        class="vl-supercluster-root-unset vl-supercluster-unset"
        data-login-path="/supercluster-ai-constellation-login/"
    >

        <!-- Visible Light Supercluster Overlay -->
        <div class="vl-supercluster-overlay">
            <!-- Top Left: Logo and Client Info -->
            <div class="vl-header">
                <div class="vl-logo">
                    <img src="https://visiblelight.ai/wp-content/uploads/2025/10/visible-light-icon-logo.svg" alt="Visible Light Icon Logo" />
                </div>
                <div class="vl-client-greeting">
                    <h2>Hello, <span id="clientName">Client</span><span class="dropdown-arrow" id="clientDropdownArrow" style="cursor: pointer; display: inline-block;"><img src="https://visiblelight.ai/wp-content/uploads/2025/08/downarrow.svg" alt="dropdown arrow" style="pointer-events: auto;"></span></h2>
                </div>
            </div>

            <!-- Main Navigation Menu -->
            <nav class="vl-main-menu">
                <ul>
                    <li class="active">
                        <a href="#" data-section="supercluster">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/supercluster-loader.svg" alt="Supercluster Icon" /></span>
                            <span class="label">Supercluster</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="web-infra">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/web-and-infra-icon.svg" alt="Web & Infra Icon" /></span>
                            <span class="label">Web & Infra</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="content">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/content-manegement-and-structure-icon.svg" alt="content icon" /></span>
                            <span class="label">Content</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="search-intel">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/supercluster-search-icon-1.svg" alt="search intel icon" /></span>
                            <span class="label">Search Intel</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="reporting">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/supercluster-reporting-icon.svg" alt="reporting icon" /></span>
                            <span class="label">Reporting</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="marketing-ads">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/web-infra-icon-2.svg" alt="marketing and campaigns icon" /></span>
                            <span class="label">Marketing & Ads</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="ecommerce">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/11/e-commerce-icon.svg" alt="e-commerce and conversions icon" /></span>
                            <span class="label">Sales & Conversions</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="security-compliance">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/security-icon.svg" alt="security and compliance icon" /></span>
                            <span class="label">Security</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="cloudops">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/11/cloudops-icon.svg" alt="cloudops icon" /></span>
                            <span class="label">CloudOps</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="user-identity">
                            <span class="icon"><img width="49" height="46" decoding="async" src="https://visiblelight.ai/wp-content/uploads/2025/07/seamless-collaboration-icon.svg" alt="user identity icon" class="wp-image-541" style="aspect-ratio:1.0606060606060606;object-fit:cover;width:35px;height:auto"></span>
                            <span class="label">Users & Identity</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="competitive">
                            <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/11/competitive-icon.svg" alt="competitive icon" /></span>
                            <span class="label">Competitive</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Bottom Left: License Key, Connection Status and Luna Chat -->
            <div class="vl-bottom-left">
                <div class="vl-license-key">
                    <div class="license-label">License Key</div>
                    <div class="license-container" id="licenseKeyContainer">
                        <span class="license-value" id="licenseKeyDisplay">Loading...</span>
                        <button class="copy-license-btn" id="copyLicenseBtn" title="Copy full license key">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="vl-connection-status" style="display: none;">
                    <div class="status-indicator">
                        <span class="status-icon" id="connectionIcon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg" alt="check mark" /></span>
                    </div>
                    <div class="status-text">
                        <p><span class="status-label">Hub Status: </span>
                        <span class="status-value" id="connectionStatus">Active</span></p>
                    </div>
                </div>
                <!-- Luna Chat Widget will be injected here if plugin is installed and licensed -->
                <div class="vl-luna-chat" id="vlLunaChatContainer"></div>
            </div>

            <!-- Bottom Right: Controls (hidden for observatory page) -->
            <div class="vl-controls" style="display: none;">
                <button class="control-btn" id="controlLeft" title="Move Left">
                    <span class="icon">←</span>
                </button>
                <button class="control-btn" id="controlRight" title="Move Right">
                    <span class="icon">→</span>
                </button>
                <button class="control-btn" id="controlZoomIn" title="Zoom In">
                    <span class="icon">+</span>
                </button>
                <button class="control-btn" id="controlZoomOut" title="Zoom Out">
                    <span class="icon">−</span>
                </button>
            </div>

            <!-- Right Sidebar: Your Supercluster + Recent Activity -->
            <aside class="vl-right-sidebar">
                <div class="vl-widget vl-widget-supercluster" id="yourSuperclusterWidget">
                    <div class="vl-widget-header">
                        <h3>Omniscient</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="vl-status-icon-wrap" title="VL Hub Status">
                            <img id="superclusterStatusIcon" src="https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg" alt="Connected" />
                        </span>
                            <button class="vl-widget-toggle" data-widget="yourSuperclusterWidget" aria-label="Hide widget">
                                <img src="https://visiblelight.ai/wp-content/uploads/2025/11/vl-eye-hide-icon.svg" alt="Hide" class="vl-toggle-icon" />
                            </button>
                        </div>
                    </div>
                    <div class="vl-widget-body">
                        <p id="superclusterSummary">Loading your Supercluster…</p>
                    </div>
                </div>

                <div class="vl-widget vl-widget-activity" id="recentActivityWidget">
                    <div class="vl-widget-header">
                        <h3>Stream Activity</h3>
                        <button class="vl-widget-toggle" data-widget="recentActivityWidget" aria-label="Hide widget">
                            <img src="https://visiblelight.ai/wp-content/uploads/2025/11/vl-eye-hide-icon.svg" alt="Hide" class="vl-toggle-icon" />
                        </button>
                    </div>
                    <div class="vl-widget-body">
                        <ul id="recentActivityList" class="vl-activity-list">
                            <li class="vl-activity-empty">No recent activity.</li>
                        </ul>
                    </div>
                </div>
            </aside>

            <!-- Page Content Container (for observatory page) -->
            <div class="vl-page-content" id="vlPageContent" style="display: block;">
                <!-- Observatory content will be inserted here -->
            </div>
        </div>

        <!-- Client Dropdown Lightbox -->
        <div class="client-dropdown-lightbox" id="clientDropdownLightbox" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
            <div class="client-dropdown-content" id="clientDropdownContent" style="pointer-events: auto; position: absolute; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px 0; min-width: 150px;">
                <div class="client-dropdown-item" id="accountSettings" style="cursor: pointer; padding: 10px 15px;">
                    <span class="dropdown-text">Account Settings</span>
                </div>
                <div class="client-dropdown-item" id="logoutOption" style="cursor: pointer; padding: 10px 15px;">
                    <span class="dropdown-text">Log Out</span>
                </div>
            </div>
        </div>

        <!-- Logout Confirmation Modal -->
        <div class="logout-modal" id="logoutModal" style="display: none; position: fixed; z-index: 10001; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); pointer-events: auto;">
            <div class="logout-modal-content" style="pointer-events: auto;">
                <h3>Log Out</h3>
                <p>Are you sure you want to log out of Visible Light?</p>
                <div class="logout-modal-buttons">
                    <button class="logout-cancel" id="logoutCancel">No, stay logged in</button>
                    <button class="logout-confirm" id="logoutConfirm">Yes, log out now</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // CRITICAL SECURITY: Verify authentication before allowing dashboard access
        const LOGIN_PAGE_URL = 'https://visiblelight.ai/auth/';
        
        // Get license key from URL
        const currentParams = new URLSearchParams(window.location.search);
        const currentLicense = currentParams.get('license') || '';
        let licenseKey = '';
        if (currentLicense) {
            const licenseMatch = currentLicense.match(/^([^/]+)/);
            if (licenseMatch) {
                licenseKey = licenseMatch[1];
            } else {
                licenseKey = currentLicense;
            }
        }

        // Update license key display
        const licenseKeyDisplay = document.getElementById('licenseKeyDisplay');
        if (licenseKeyDisplay && licenseKey) {
            licenseKeyDisplay.textContent = licenseKey;
        }

        // Copy license key functionality
        const copyLicenseBtn = document.getElementById('copyLicenseBtn');
        if (copyLicenseBtn) {
            copyLicenseBtn.addEventListener('click', async function() {
                const key = licenseKey || licenseKeyDisplay?.textContent || '';
                if (!key) return;
                
                try {
                    await navigator.clipboard.writeText(key);
                    const btn = copyLicenseBtn;
                    const originalText = btn.title;
                    btn.title = 'Copied!';
                    setTimeout(() => { btn.title = originalText; }, 2000);
                } catch (err) {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = key;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        copyLicenseBtn.title = 'Copied!';
                        setTimeout(() => { copyLicenseBtn.title = 'Copy full license key'; }, 2000);
                    } catch (e) {
                        console.error('Copy failed:', e);
                    }
                    document.body.removeChild(textarea);
                }
            });
        }

        // Client dropdown functionality
        const clientDropdownArrow = document.getElementById('clientDropdownArrow');
        const clientDropdownLightbox = document.getElementById('clientDropdownLightbox');
        const accountSettings = document.getElementById('accountSettings');
        const logoutOption = document.getElementById('logoutOption');

        if (clientDropdownArrow) {
            clientDropdownArrow.addEventListener('click', function(e) {
                e.stopPropagation();
                const arrowRect = clientDropdownArrow.getBoundingClientRect();
                const dropdownContent = document.getElementById('clientDropdownContent');
                if (dropdownContent) {
                    dropdownContent.style.top = (arrowRect.bottom + 5) + 'px';
                    dropdownContent.style.left = (arrowRect.left - 100) + 'px';
                }
                
                const isVisible = clientDropdownLightbox.style.display === 'block';
                if (isVisible) {
                    clientDropdownLightbox.style.display = 'none';
                } else {
                    clientDropdownLightbox.style.display = 'block';
                }
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (clientDropdownLightbox && !clientDropdownLightbox.contains(e.target) && !clientDropdownArrow?.contains(e.target)) {
                clientDropdownLightbox.style.display = 'none';
            }
        });

        // Logout modal functionality
        const logoutModal = document.getElementById('logoutModal');
        const logoutCancel = document.getElementById('logoutCancel');
        const logoutConfirm = document.getElementById('logoutConfirm');

        if (logoutOption) {
            logoutOption.addEventListener('click', function() {
                if (logoutModal) {
                    logoutModal.style.display = 'block';
                }
            });
        }

        if (logoutCancel) {
            logoutCancel.addEventListener('click', function() {
                if (logoutModal) {
                    logoutModal.style.display = 'none';
                }
            });
        }

        if (logoutConfirm) {
            logoutConfirm.addEventListener('click', function() {
                window.location.href = LOGIN_PAGE_URL + '?action=logout';
            });
        }

        // Update client name
        async function updateClientName() {
            const clientNameEl = document.getElementById('clientName');
            if (!clientNameEl) return;

            if (licenseKey) {
                // First priority: Try Luna License Manager session
                try {
                    const sessionData = await fetchUserDisplayName();
                    if (sessionData && sessionData.user && sessionData.user.display_name) {
                        const firstName = sessionData.user.display_name.split(' ')[0];
                        clientNameEl.textContent = firstName;
                        return;
                    }
                } catch (error) {
                    console.log('Session fetch error:', error);
                }

                // Second priority: Try WordPress API
                try {
                    const userData = await fetchUserData();
                    if (userData && userData.name) {
                        const firstName = userData.name.split(' ')[0];
                        clientNameEl.textContent = firstName;
                        return;
                    }
                } catch (error) {
                    console.log('User data fetch error:', error);
                }
            }

            // Default fallback
            clientNameEl.textContent = 'Client';
        }

        // Fetch user data from WordPress API
        async function fetchUserData() {
            try {
                const response = await fetch('https://visiblelight.ai/wp-json/wp/v2/users/me', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const userData = await response.json();
                    return userData;
                }
            } catch (error) {
                console.log('Could not fetch user data:', error);
            }
            return null;
        }

        // Fetch user display name from Luna License Manager API
        async function fetchUserDisplayName() {
            try {
                const response = await fetch('https://visiblelight.ai/wp-json/vl-hub/v1/session', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const sessionData = await response.json();
                    return sessionData;
                }
            } catch (error) {
                console.log('Could not fetch session data:', error);
            }
            return null;
        }

        // Render Omniscient App Observatory page
        async function renderOmniscientAppObservatory() {
            console.log('[Omniscient App Observatory] Rendering page...');
            
            // Ensure overlays and menus remain visible
            const overlay = document.querySelector('.vl-supercluster-overlay');
            const header = document.querySelector('.vl-header');
            const mainMenu = document.querySelector('.vl-main-menu');
            const rightSidebar = document.querySelector('.vl-right-sidebar');
            
            if (overlay) {
                overlay.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            }
            if (header) {
                header.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            }
            if (mainMenu) {
                mainMenu.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            }
            if (rightSidebar) {
                rightSidebar.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            }
            
            // Show the page content container
            const pageContent = document.getElementById('vlPageContent');
            if (!pageContent) {
                console.error('[Omniscient App Observatory] Page content element not found!');
                return;
            }
            
            if (!licenseKey) {
                pageContent.innerHTML = '<div style="padding: 40px; color: #fff4e9; text-align: center;"><h1>Error</h1><p>License key not found.</p></div>';
                return;
            }
            
            try {
                console.log('[Omniscient App Observatory] Fetching sites for license:', licenseKey);
                
                // Fetch all sites for this client
                const response = await fetch(`https://visiblelight.ai/wp-json/vl-hub/v1/client-sites?license=${encodeURIComponent(licenseKey)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                
                console.log('[Omniscient App Observatory] Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Omniscient App Observatory] API error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('[Omniscient App Observatory] Response data:', data);
                
                if (!data.ok) {
                    throw new Error(data.error || 'Invalid response from server');
                }
                
                const sites = data.sites || [];
                const totalSites = data.total || 0;
                
                console.log('[Omniscient App Observatory] Sites found:', totalSites, sites);
                
                // Build HTML with explicit background
                let html = '<div class="omniscient-observatory" style="min-height: 100vh; background: #000000 !important; color: #fff4e9; padding: 40px 20px; max-width: 1400px; margin: 0 auto; position: relative; z-index: 1000;">';
                
                // Header with total count
                html += '<div style="margin-bottom: 30px;">';
                html += '<h1 class="TypeGradient" style="margin-bottom: 10px; font-size: 2rem;">Omniscient App Observatory</h1>';
                html += '<p style="color: #9A9793; font-size: 1rem; margin: 0 0 20px 0;">Total Connected Sites/Apps: <strong style="color: #fff4e9;">' + totalSites + '</strong></p>';
                
                // Search and View Toggle
                html += '<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">';
                html += '<div style="flex: 1; min-width: 300px;">';
                html += '<input type="text" id="observatory-search" placeholder="Search sites/apps..." style="width: 100%; padding: 10px 16px; background: #2E2C2A50; border: 1px solid #5A575335; border-radius: 6px; color: #fff4e9; font-size: 0.875rem; outline: none;" />';
                html += '</div>';
                html += '<div style="display: flex; align-items: center; gap: 10px;">';
                html += '<span style="color: #9A9793; font-size: 0.875rem;">View:</span>';
                html += '<button id="view-list-btn" class="view-toggle-btn active" data-view="list" style="padding: 8px 16px; background: #2E2C2A; border: 1px solid #5A575335; color: #fff4e9; border-radius: 6px; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">List</button>';
                html += '<button id="view-block-btn" class="view-toggle-btn" data-view="block" style="padding: 8px 16px; background: #2E2C2A50; border: 1px solid #5A575335; color: #9A9793; border-radius: 6px; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">Block</button>';
                html += '</div>';
                html += '</div>';
                
                // Sites Container
                html += '<div id="observatory-sites-container" class="observatory-list-view" style="display: grid; gap: 20px;">';
                
                if (sites.length === 0) {
                    html += '<div style="text-align: center; padding: 60px 20px; color: #9A9793;"><p>No sites/apps found. Assign sites to this client in WP Admin > VL Clients > VL Hub Profile > Client Syncing.</p></div>';
                } else {
                    sites.forEach((site, index) => {
                        const siteId = 'site-' + index;
                        html += '<div class="observatory-site-item" data-site-url="' + (site.url || '').toLowerCase() + '" data-site-title="' + (site.title || '').toLowerCase() + '" data-site-domain="' + (site.domain || '').toLowerCase() + '" style="background: #000000; border: 1px solid #2E2C2A; border-radius: 8px; padding: 20px; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.borderColor=\'#5A5753\';" onmouseout="this.style.borderColor=\'#2E2C2A\';" onclick="window.open(\'' + (site.url || '#') + '\', \'_blank\');">';
                        
                        // Block view layout
                        html += '<div class="observatory-site-block" style="display: grid; grid-template-columns: 120px 1fr auto; gap: 20px; align-items: start;">';
                        
                        // OG Image
                        html += '<div style="width: 120px; height: 120px; background: #2E2C2A; border-radius: 6px; overflow: hidden; flex-shrink: 0;">';
                        if (site.og_image) {
                            html += '<img src="' + site.og_image + '" alt="' + (site.title || site.domain || 'Site') + '" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'<div style=\\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#9A9793;font-size:0.75rem;\\\'>No Image</div>\';" />';
                        } else {
                            html += '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #9A9793; font-size: 0.75rem;">No Image</div>';
                        }
                        html += '</div>';
                        
                        // Site Info
                        html += '<div style="flex: 1;">';
                        html += '<h3 style="color: #fff4e9; margin: 0 0 8px 0; font-size: 1.2rem; font-weight: 400;">' + (site.title || site.domain || site.url || 'Untitled Site') + '</h3>';
                        html += '<p style="color: #9A9793; margin: 0 0 12px 0; font-size: 0.875rem; word-break: break-all;">' + (site.url || '') + '</p>';
                        
                        // Status badges
                        html += '<div style="display: flex; gap: 10px; flex-wrap: wrap;">';
                        
                        // Ping Status
                        html += '<span style="padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: ' + (site.ping_color || '#9A9793') + '; color: #000;">' + (site.ping_label || 'Unknown') + '</span>';
                        
                        // SSL/TLS Status
                        let sslLabel = 'Unknown';
                        let sslColor = '#9A9793';
                        if (site.ssl_status === 'valid') {
                            sslLabel = 'SSL Valid';
                            sslColor = '#00a32a';
                        } else if (site.ssl_status === 'expiring_soon') {
                            sslLabel = 'SSL Expiring Soon';
                            sslColor = '#dba617';
                        } else if (site.ssl_status === 'expired') {
                            sslLabel = 'SSL Expired';
                            sslColor = '#d63638';
                        } else if (site.ssl_status === 'not_https') {
                            sslLabel = 'Not HTTPS';
                            sslColor = '#9A9793';
                        }
                        html += '<span style="padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: ' + sslColor + '; color: #000;">' + sslLabel + '</span>';
                        
                        html += '</div>';
                        html += '</div>';
                        
                        html += '</div>';
                        
                        // List view layout (hidden by default)
                        html += '<div class="observatory-site-list" style="display: none; grid-template-columns: 80px 1fr auto auto; gap: 16px; align-items: center;">';
                        html += '<div style="width: 80px; height: 80px; background: #2E2C2A; border-radius: 6px; overflow: hidden; flex-shrink: 0;">';
                        if (site.og_image) {
                            html += '<img src="' + site.og_image + '" alt="' + (site.title || site.domain || 'Site') + '" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display=\'none\';" />';
                        }
                        html += '</div>';
                        html += '<div style="flex: 1; min-width: 0;">';
                        html += '<h3 style="color: #fff4e9; margin: 0 0 4px 0; font-size: 1rem; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + (site.title || site.domain || site.url || 'Untitled Site') + '</h3>';
                        html += '<p style="color: #9A9793; margin: 0; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + (site.url || '') + '</p>';
                        html += '</div>';
                        html += '<div style="display: flex; gap: 8px;">';
                        html += '<span style="padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: ' + (site.ping_color || '#9A9793') + '; color: #000;">' + (site.ping_label || 'Unknown') + '</span>';
                        html += '<span style="padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: ' + sslColor + '; color: #000;">' + sslLabel + '</span>';
                        html += '</div>';
                        html += '</div>';
                        
                        html += '</div>';
                    });
                }
                
                html += '</div>';
                html += '</div>';
                
                // Add CSS
                html += '<style>';
                html += '.observatory-list-view .observatory-site-item > .observatory-site-list { display: grid !important; }';
                html += '.observatory-list-view .observatory-site-item > .observatory-site-block { display: none !important; }';
                html += '.observatory-block-view .observatory-site-item > .observatory-site-block { display: grid !important; }';
                html += '.observatory-block-view .observatory-site-item > .observatory-site-list { display: none !important; }';
                html += '.view-toggle-btn.active { background: #2E2C2A !important; color: #fff4e9 !important; }';
                html += '.view-toggle-btn:not(.active) { background: #2E2C2A50 !important; color: #9A9793 !important; }';
                html += '</style>';
                
                pageContent.innerHTML = html;
                
                // Force page content to be visible
                pageContent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000 !important; background: #000000 !important; min-height: 100vh !important;';
                
                // Initialize search and view toggle
                const searchInput = document.getElementById('observatory-search');
                const viewListBtn = document.getElementById('view-list-btn');
                const viewBlockBtn = document.getElementById('view-block-btn');
                const sitesContainer = document.getElementById('observatory-sites-container');
                
                // Search functionality
                if (searchInput) {
                    searchInput.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.toLowerCase().trim();
                        const siteItems = document.querySelectorAll('.observatory-site-item');
                        
                        siteItems.forEach(item => {
                            const url = item.getAttribute('data-site-url') || '';
                            const title = item.getAttribute('data-site-title') || '';
                            const domain = item.getAttribute('data-site-domain') || '';
                            
                            if (!searchTerm || url.includes(searchTerm) || title.includes(searchTerm) || domain.includes(searchTerm)) {
                                item.style.display = '';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    });
                }
                
                // View toggle functionality
                if (viewListBtn && viewBlockBtn && sitesContainer) {
                    viewListBtn.addEventListener('click', function() {
                        sitesContainer.className = 'observatory-list-view';
                        viewListBtn.classList.add('active');
                        viewBlockBtn.classList.remove('active');
                    });
                    
                    viewBlockBtn.addEventListener('click', function() {
                        sitesContainer.className = 'observatory-block-view';
                        viewBlockBtn.classList.add('active');
                        viewListBtn.classList.remove('active');
                    });
                }
                
            } catch (error) {
                console.error('[Omniscient App Observatory] Error rendering:', error);
                pageContent.innerHTML = '<div style="padding: 40px; color: #fff4e9; text-align: center;"><h1>Error</h1><p>Failed to load Omniscient App Observatory: ' + error.message + '</p></div>';
            }
        }

        // Initialize on page load
        async function initializePage() {
            // Update client name
            await updateClientName();
            
            // Render observatory page
            await renderOmniscientAppObservatory();
        }

        // Run initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>

