<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connections - Visible Light AI Supercluster</title>
    <link rel="stylesheet" type="text/css" href="https://supercluster.visiblelight.ai/styles.css" />
    <style>
        /* Hide three.js canvas on connections page */
        #vlSuperclusterRoot canvas {
            display: none !important;
            visibility: hidden !important;
        }
        /* Ensure page content is visible */
        #vlPageContent {
            display: block !important;
        }
        /* Force Refresh button styles */
        .force-refresh-btn {
            transition: all 0.2s ease;
        }
        .force-refresh-btn:hover:not(:disabled) {
            background: #2E2C2A80 !important;
            border-color: #5A575350 !important;
            color: #fff4e9 !important;
        }
        .force-refresh-btn:disabled,
        .force-refresh-btn.inactive {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        /* Floating animation for connection icons */
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0);
            }
            25% {
                transform: translate(2px, -2px);
            }
            50% {
                transform: translate(-1px, 2px);
            }
            75% {
                transform: translate(-2px, -1px);
            }
        }
        .connection-icon {
            animation: float 6s ease-in-out infinite;
        }
        /* Connection Details Modal */
        #connectionDetailsModal {
            -webkit-overflow-scrolling: touch;
        }
        #connectionDetailsModal > div {
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #2e2c2a #000000;
        }
        #connectionDetailsModal > div::-webkit-scrollbar {
            width: 8px;
        }
        #connectionDetailsModal > div::-webkit-scrollbar-track {
            background: #000000;
        }
        #connectionDetailsModal > div::-webkit-scrollbar-thumb {
            background: #2e2c2a;
            border-radius: 4px;
        }
        #connectionDetailsModal > div::-webkit-scrollbar-thumb:hover {
            background: #5A5753;
        }
        #connectionModalContent {
            font-family: 'Courier New', monospace;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div
        id="vlSuperclusterRoot"
        class="vl-supercluster-root vl-supercluster"
        data-login-path="/supercluster-ai-constellation-login/"
    >
        <!-- Visible Light Supercluster Overlay -->
        <div class="vl-supercluster-overlay">
            <!-- Left Sidebar Container -->
            <div class="left-sidebar-container">
                <!-- Top Left: Logo -->
                <div class="vl-header">
                    <div class="vl-logo">
                        <img src="https://visiblelight.ai/wp-content/uploads/2025/10/visible-light-icon-logo.svg" alt="Visible Light Icon Logo" />
                    </div>
                </div>

                <!-- Main Navigation Menu -->
                <nav class="vl-main-menu">
                    <ul>
                        <li>
                            <a href="#" data-section="supercluster">
                                <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/supercluster-loader.svg" alt="Supercluster Icon" /></span>
                                <span class="label">Data Supercluster</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-section="compose" data-path="luna-compose">
                                <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/11/luna-ai-composer-icon-1.svg" alt="Compose Icon" /></span>
                                <span class="label">AI Composer</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-section="report" data-path="luna-report">
                                <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/supercluster-reporting-icon.svg" alt="Report Icon" /></span>
                                <span class="label">AI Reports</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-section="automate" data-path="luna-automate">
                                <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/supercluster-loader.svg" alt="Automate Icon" /></span>
                                <span class="label">Automations</span>
                            </a>
                        </li>
                        <li class="active">
                            <a href="#" data-section="connect" data-path="luna-connect">
                                <span class="icon"><img src="https://visiblelight.ai/wp-content/uploads/2025/11/cloudops-icon.svg" alt="Connect Icon" /></span>
                                <span class="label">Connections</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Right Sidebar: Your Supercluster + Recent Activity (Scrollable) -->
                <aside class="vl-right-sidebar">
                    <div class="vl-widget vl-widget-supercluster" id="yourSuperclusterWidget">
                        <div class="vl-widget-header">
                            <h3>Omniscient</h3>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <button class="vl-widget-toggle" data-widget="yourSuperclusterWidget" aria-label="Show widget">
                                    <img src="https://visiblelight.ai/wp-content/uploads/2025/11/vl-eye-icon.svg" alt="Show" class="vl-toggle-icon" />
                                </button>
                            </div>
                        </div>
                        <div class="vl-widget-body vl-widget-body-hidden">
                            <p id="superclusterSummary">Loading your Observatory…</p>
                        </div>
                    </div>

                    <div class="vl-widget vl-widget-activity" id="recentActivityWidget">
                        <div class="vl-widget-header">
                            <h3>Insights</h3>
                            <button class="vl-widget-toggle" data-widget="recentActivityWidget" aria-label="Show widget">
                                <img src="https://visiblelight.ai/wp-content/uploads/2025/11/vl-eye-icon.svg" alt="Show" class="vl-toggle-icon" />
                            </button>
                        </div>
                        <div class="vl-widget-body vl-widget-body-hidden">
                            <div id="lunaConnectionsSummary" style="color: #fff4e9; font-size: 0.875rem; line-height: 1.5;">
                                <p>Loading insights...</p>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
            
            <!-- Client Admin Menu Container -->
            <div class="client-admin-menu-container">
                <div class="vl-client-greeting">
                    <div id="clientAvatar" style="display: inline-block; width: 30px; height: 30px; border: 1px solid #2e2c2a; border-radius: 40px; margin-right: 10px; vertical-align: middle; overflow: hidden; flex-shrink: 0;">
                        <!-- Avatar image or initials will be inserted here -->
                    </div>
                    <h2 style="display: inline-block; vertical-align: middle; margin: 0;"><span id="dynamicGreeting">Hello,</span> <span id="clientName">Client</span><span class="dropdown-arrow" id="clientDropdownArrow" style="cursor: pointer; display: inline-block;"><img src="https://visiblelight.ai/wp-content/uploads/2025/08/downarrow.svg" alt="dropdown arrow" style="pointer-events: auto;"></span></h2>
                </div>
            </div>

            <!-- Page Content Container -->
            <div class="vl-page-content" id="vlPageContent" style="display: block; min-height: 100vh; background: #000000; padding: 0 0;">
                <!-- Connections content will be inserted here -->
                <div id="connections-content" style="width: 60%; max-width: 100%; margin: 0 auto; position: relative; z-index: 1000;">
                    <div style="text-align: center; padding: 60px 20px; color: #9A9793;">
                        <p>Loading connections...</p>
                    </div>
                </div>
            </div>

            <!-- Luna Chat Widget Container - Positioned bottom-right -->
            <div id="vlLunaChatContainer"></div>
        </div>

        <!-- Client Dropdown Lightbox -->
        <div class="client-dropdown-lightbox" id="clientDropdownLightbox" style="display: none; position: fixed; z-index: 10000; top: 0; width: 100%; height: 100%; pointer-events: none;">
            <div class="client-dropdown-content" id="clientDropdownContent" style="pointer-events: auto; position: absolute; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px 0; min-width: 150px;left: auto !important;">
                <div class="client-dropdown-item" id="accountSettings" style="font-size:.9rem; cursor: pointer; padding: 2.5px 10px; font-weight:500;">
                    <span class="dropdown-text">Account Settings</span>
                </div>
                <div class="client-dropdown-item" id="logoutOption" style="font-size:.9rem; cursor: pointer; padding: 2.5px 10px; font-weight:500;">
                    <span class="dropdown-text">Log Out</span>
                </div>
                <div class="breakLine"></div>
                <div class="client-dropdown-item" id="launchTutorial" style="font-size:.9rem;cursor: pointer; padding: 15px 10px 2.5px 10px; font-weight:500;">
                    <span class="dropdown-text">Launch Tutorial</span>
                </div>
                <div class="client-dropdown-item" id="contactSupport" style="font-size:.9rem;cursor: pointer; padding: 2.5px 10px 2.5px 10px; font-weight:500;">
                    <span class="dropdown-text"><a href="mailto:support@visiblelight.ai">Contact Support</a></span>
                </div>
                <div class="vl-connection-status" style="border-top: 1px solid #000; margin-top: 8px; padding: 8px 10px 0 10px;">
                    <div class="status-indicator" style="display:inline-block; margin-right:6px; vertical-align:middle;">
                        <span class="status-icon" id="connectionIcon"><img src="https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg" alt="check mark" /></span>
                    </div>
                    <div class="status-text" style="display:inline-block; vertical-align:middle; font-size:0.8rem;">
                        <span class="status-label">Hub Status: </span>
                        <span class="status-value" id="connectionStatus">Active</span>
                    </div>
                </div>
                <div class="vl-license-key" style="border-top: 1px solid #000; margin-top: 8px; padding-top: 8px; padding-bottom:0;">
                    <div class="license-label" style="padding: 0; font-size: 0.7rem; color: #8F9193; text-transform: uppercase; letter-spacing: .1rem;">License Key</div>
                    <div class="license-container" id="licenseKeyContainer" style="padding: 0;">
                        <span class="license-value" id="licenseKeyDisplay" style="display: block; color: #fff4e9; font-weight: 600; font-size: 0.9rem; font-family: 'Supercluster Mono'; word-break: break-all;">Loading...</span>
                        <button class="copy-license-btn" id="copyLicenseBtn" title="Copy full license key" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; color: rgba(255, 255, 255, 0.7); padding: 3px 0 0;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logout Confirmation Modal -->
        <div class="logout-modal" id="logoutModal" style="display: none; position: fixed; z-index: 10001; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); pointer-events: auto;">
            <div class="logout-modal-content" style="pointer-events: auto;">
                <img src="https://visiblelight.ai/wp-content/uploads/2025/10/visible-light-icon-logo.svg" alt="Visible Light Icon Logo">
                <h3>Logging out of Visible Light</h3>
                <p>Are you sure you want to log out of Visible Light?</p>
                <div class="logout-modal-buttons">
                    <button class="logout-cancel" id="logoutCancel">No, stay logged in</button>
                    <button class="logout-confirm" id="logoutConfirm">Yes, log out now</button>
                </div>
            </div>
        </div>

        <!-- Tutorial Overlay -->
        <div id="tutorial-container"></div>

        <!-- Connection Details Popup -->
        <div id="connectionDetailsModal" style="display: none; position: fixed; z-index: 20000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); overflow-y: auto;">
            <div style="position: relative; max-width: 900px; margin: 40px auto; background: #000000; border: 1px solid #2e2c2a; border-radius: 8px; padding: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #2e2c2a; padding-bottom: 15px;">
                    <h2 id="connectionModalTitle" style="color: #fff4e9; margin: 0; font-size: 1.5rem; font-weight: 400;">Connection Details</h2>
                    <button id="closeConnectionModal" style="background: transparent; border: none; color: #9A9793; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#2e2c2a'; this.style.color='#fff4e9';" onmouseout="this.style.background='transparent'; this.style.color='#9A9793';">×</button>
                </div>
                <div id="connectionModalContent" style="color: #fff4e9; font-size: 0.875rem; line-height: 1.6;">
                    <p style="color: #9A9793;">Loading connection data...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Get license key from URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlLicense = urlParams.get('license') || '';
        let licenseKey = '';
        if (urlLicense) {
            const licenseMatch = urlLicense.match(/^([^/]+)/);
            if (licenseMatch) {
                licenseKey = licenseMatch[1];
            } else {
                licenseKey = urlLicense;
            }
        }

        // Connection name mapping
        const connectionNames = {
            'cloudflare': 'Cloudflare',
            'ssl_tls': 'SSL/TLS Status',
            'liquidweb': 'Liquid Web',
            'aws_s3': 'AWS S3',
            'ga4': 'Google Analytics 4',
            'gsc': 'Google Search Console',
            'competitor_reports': 'Competitive Intelligence',
            'vldr_metrics': 'VLDR Metrics',
            'wordpress_users': 'WordPress Users',
            'wordpress_content': 'WordPress Content',
            'luna_wordpress': 'Luna WordPress Plugin'
        };

        // Connection icon/description mapping - using SVG image URLs
        const connectionInfo = {
            'cloudflare': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'CDN & Security' },
            'ssl_tls': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'SSL Certificate Status' },
            'liquidweb': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'Hosting Provider' },
            'aws_s3': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'Cloud Storage' },
            'ga4': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'Web Analytics' },
            'gsc': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'Search Performance' },
            'competitor_reports': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'Competitive Analysis' },
            'vldr_metrics': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'VLDR Metrics' },
            'wordpress_users': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'User Management' },
            'wordpress_content': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg', desc: 'Content Management' },
            'luna_wordpress': { icon: 'https://visiblelight.ai/wp-content/uploads/2025/11/luna-ai-composer-icon-1.svg', desc: 'AI Assistant Plugin' }
        };

        // Escape HTML attributes
        const escapeAttr = (value) => {
            if (value === undefined || value === null) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        };

        // Force refresh system (manual only - no auto-refresh to prevent interference with Luna Composer)
        const FORCE_REFRESH_STORAGE_KEY = 'vl-supercluster-last-force-refresh';
        const FORCE_REFRESH_COOLDOWN_MS = 6 * 60 * 60 * 1000; // 6 hours

        // Removed 24-hour auto-refresh system to prevent interference with Luna Composer requests

        // Check if force refresh is available (6-hour cooldown)
        function canForceRefresh() {
            const lastForceRefresh = localStorage.getItem(FORCE_REFRESH_STORAGE_KEY);
            if (!lastForceRefresh) {
                return true; // Never used, available
            }
            const lastForceRefreshTime = parseInt(lastForceRefresh, 10);
            const now = Date.now();
            return (now - lastForceRefreshTime) >= FORCE_REFRESH_COOLDOWN_MS;
        }

        // Get time remaining until force refresh is available
        function getForceRefreshTimeRemaining() {
            const lastForceRefresh = localStorage.getItem(FORCE_REFRESH_STORAGE_KEY);
            if (!lastForceRefresh) {
                return 0;
            }
            const lastForceRefreshTime = parseInt(lastForceRefresh, 10);
            const now = Date.now();
            const elapsed = now - lastForceRefreshTime;
            const remaining = FORCE_REFRESH_COOLDOWN_MS - elapsed;
            return remaining > 0 ? remaining : 0;
        }

        // Format time remaining for display
        function formatTimeRemaining(ms) {
            const hours = Math.floor(ms / (60 * 60 * 1000));
            const minutes = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // Update force refresh button state
        function updateForceRefreshButton() {
            const btn = document.getElementById('force-refresh-btn');
            if (!btn) return;

            const canRefresh = canForceRefresh();
            if (canRefresh) {
                btn.disabled = false;
                btn.classList.remove('inactive');
                btn.textContent = 'Force Refresh';
                btn.title = 'Refresh connections data';
            } else {
                btn.disabled = true;
                btn.classList.add('inactive');
                const remaining = getForceRefreshTimeRemaining();
                const timeStr = formatTimeRemaining(remaining);
                btn.textContent = `Force Refresh (${timeStr})`;
                btn.title = `Force refresh available in ${timeStr}`;
            }
        }

        // Render connections page
        async function renderConnections() {
            const contentDiv = document.getElementById('connections-content');
            if (!contentDiv) {
                console.error('[Connections] Content div not found');
                return;
            }

            if (!licenseKey) {
                contentDiv.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #9A9793;"><h1 style="color: #fff4e9;">Error</h1><p>License key not found.</p></div>';
                return;
            }

            // Store current view state and search term before refresh
            let currentViewState = window.connectionsViewState || 'block'; // default to 'block'
            let currentSearchTerm = window.connectionsSearchTerm || '';
            
            // Get current view state from DOM if available
            const existingContainer = document.getElementById('connections-container');
            if (existingContainer) {
                if (existingContainer.classList.contains('connections-block-view')) {
                    currentViewState = 'block';
                } else {
                    currentViewState = 'list';
                }
            }
            
            // Get current search term from DOM if available
            const existingSearchInput = document.getElementById('connections-search');
            if (existingSearchInput && existingSearchInput.value) {
                currentSearchTerm = existingSearchInput.value;
            }

            try {
                console.log('[Connections] Fetching connections for license:', licenseKey);
                
                // Fetch all connections with cache-busting for real-time updates
                const response = await fetch(`https://visiblelight.ai/wp-json/vl-hub/v1/all-connections?license=${encodeURIComponent(licenseKey)}&_t=${Date.now()}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                console.log('[Connections] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Connections] API error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('[Connections] Response data:', data);

                if (!data.ok) {
                    throw new Error(data.error || 'Invalid response from server');
                }

                // Extract connections data
                const connectionsData = data?.ok && data?.data ? data.data : data;
                
                // Get active_streams from connections data (matches luna-license-manager structure)
                let activeStreams = 0;
                if (connectionsData?.active_streams) {
                    activeStreams = parseInt(connectionsData.active_streams, 10);
                } else if (connectionsData?.stream_count) {
                    activeStreams = parseInt(connectionsData.stream_count, 10);
                } else if (data?.data?.connections?.active_streams) {
                    activeStreams = parseInt(data.data.connections.active_streams, 10);
                } else if (data?.data?.connections?.stream_count) {
                    activeStreams = parseInt(data.data.connections.stream_count, 10);
                }
                
                // Build list of connected connections only
                const connectedConnections = [];
                
                // Check each connection type
                if (connectionsData.cloudflare && connectionsData.cloudflare.connected === true) {
                    connectedConnections.push({
                        id: 'cloudflare',
                        name: connectionNames.cloudflare,
                        ...connectionInfo.cloudflare,
                        data: connectionsData.cloudflare
                    });
                }
                
                if (connectionsData.ssl_tls && (connectionsData.ssl_tls.connected === true || connectionsData.ssl_tls.certificate)) {
                    connectedConnections.push({
                        id: 'ssl_tls',
                        name: connectionNames.ssl_tls,
                        ...connectionInfo.ssl_tls,
                        data: connectionsData.ssl_tls
                    });
                }
                
                if (connectionsData.liquidweb && connectionsData.liquidweb.connected === true) {
                    connectedConnections.push({
                        id: 'liquidweb',
                        name: connectionNames.liquidweb,
                        ...connectionInfo.liquidweb,
                        data: connectionsData.liquidweb
                    });
                }
                
                if (connectionsData.aws_s3 && connectionsData.aws_s3.connected === true) {
                    connectedConnections.push({
                        id: 'aws_s3',
                        name: connectionNames.aws_s3,
                        ...connectionInfo.aws_s3,
                        data: connectionsData.aws_s3
                    });
                }
                
                if (connectionsData.ga4 && (connectionsData.ga4.property_id || connectionsData.ga4.metrics)) {
                    connectedConnections.push({
                        id: 'ga4',
                        name: connectionNames.ga4,
                        ...connectionInfo.ga4,
                        data: connectionsData.ga4
                    });
                }
                
                if (connectionsData.gsc && connectionsData.gsc.connected === true) {
                    connectedConnections.push({
                        id: 'gsc',
                        name: connectionNames.gsc,
                        ...connectionInfo.gsc,
                        data: connectionsData.gsc
                    });
                }
                
                if (connectionsData.competitor_reports && Array.isArray(connectionsData.competitor_reports) && connectionsData.competitor_reports.length > 0) {
                    connectedConnections.push({
                        id: 'competitor_reports',
                        name: connectionNames.competitor_reports,
                        ...connectionInfo.competitor_reports,
                        data: connectionsData.competitor_reports
                    });
                }
                
                if (connectionsData.vldr_metrics && Object.keys(connectionsData.vldr_metrics).length > 0) {
                    connectedConnections.push({
                        id: 'vldr_metrics',
                        name: connectionNames.vldr_metrics,
                        ...connectionInfo.vldr_metrics,
                        data: connectionsData.vldr_metrics
                    });
                }
                
                if (connectionsData.wordpress_users && connectionsData.wordpress_users.total > 0) {
                    connectedConnections.push({
                        id: 'wordpress_users',
                        name: connectionNames.wordpress_users,
                        ...connectionInfo.wordpress_users,
                        data: connectionsData.wordpress_users
                    });
                }
                
                if (connectionsData.wordpress_content && (connectionsData.wordpress_content.total_posts > 0 || connectionsData.wordpress_content.total_pages > 0 || (connectionsData.wordpress_content.posts && connectionsData.wordpress_content.posts.length > 0) || (connectionsData.wordpress_content.pages && connectionsData.wordpress_content.pages.length > 0))) {
                    connectedConnections.push({
                        id: 'wordpress_content',
                        name: connectionNames.wordpress_content,
                        ...connectionInfo.wordpress_content,
                        data: connectionsData.wordpress_content
                    });
                }

                // Check if Luna WordPress plugin is installed
                // Get client site URL from profile to check for Luna plugin
                try {
                    const profileUrl = `https://visiblelight.ai/wp-json/vl-hub/v1/profile?license=${encodeURIComponent(licenseKey)}`;
                    const profileResponse = await fetch(profileUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include'
                    });
                    
                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();
                        let clientSiteUrl = null;
                        
                        // Get client site URL from profile
                        if (profileData.data?.site_info?.site) {
                            clientSiteUrl = profileData.data.site_info.site;
                        } else if (profileData.site_info?.site) {
                            clientSiteUrl = profileData.site_info.site;
                        } else if (profileData.site?.home_url) {
                            clientSiteUrl = profileData.site.home_url;
                        } else if (profileData.home_url) {
                            clientSiteUrl = profileData.home_url;
                        } else if (profileData.site) {
                            clientSiteUrl = typeof profileData.site === 'string' ? profileData.site : profileData.site.home_url;
                        }
                        
                        // Check if Luna plugin is installed by checking widget endpoint
                        if (clientSiteUrl) {
                            const widgetHtmlUrl = `${clientSiteUrl.replace(/\/$/, '')}/wp-json/luna_widget/v1/widget/html?vl_key=${encodeURIComponent(licenseKey)}`;
                            
                            try {
                                const widgetCheckResponse = await fetch(widgetHtmlUrl, {
                                    method: 'GET',
                                    credentials: 'include',
                                    mode: 'cors',
                                    headers: {
                                        'Accept': 'application/json'
                                    }
                                });
                                
                                // If widget endpoint returns OK, plugin is installed
                                if (widgetCheckResponse.ok) {
                                    const widgetData = await widgetCheckResponse.json();
                                    if (widgetData.ok && widgetData.html) {
                                        connectedConnections.push({
                                            id: 'luna_wordpress',
                                            name: connectionNames.luna_wordpress,
                                            ...connectionInfo.luna_wordpress,
                                            data: {
                                                connected: true,
                                                site_url: clientSiteUrl,
                                                plugin_version: widgetData.version || 'installed',
                                                installed_at: new Date().toISOString()
                                            }
                                        });
                                        console.log('[Connections] Luna WordPress plugin detected and added to connections');
                                    }
                                }
                            } catch (widgetError) {
                                // Plugin not installed or endpoint not available - silently skip
                                console.log('[Connections] Luna WordPress plugin not detected:', widgetError.message);
                            }
                        }
                    }
                } catch (profileError) {
                    // Profile fetch failed - silently skip Luna plugin check
                    console.log('[Connections] Could not check for Luna plugin:', profileError.message);
                }

                const totalConnections = connectedConnections.length;
                const connectionLabel = totalConnections === 1 ? 'connection' : 'connections';

                console.log('[Connections] Connected connections found:', totalConnections, connectedConnections);

                // activeStreams is already fetched from all-connections response above
                
                // Calculate JSON lines from the full response data
                let jsonLinesCount = 0;
                try {
                    const jsonStr = JSON.stringify(data, null, 2);
                    jsonLinesCount = jsonStr.split('\n').length;
                } catch (e) {
                    // Fallback: estimate based on data size
                    jsonLinesCount = Object.keys(connectionsData).length * 10;
                }
                
                // Update superclusterSummary
                const superclusterSummaryEl = document.getElementById('superclusterSummary');
                if (superclusterSummaryEl) {
                    superclusterSummaryEl.textContent = `Observing ${totalConnections} Connections, spawning ${activeStreams} Streams with ${jsonLinesCount} lines.`;
                }
                
                // Generate Luna insights
                generateLunaConnectionsInsights(connectedConnections, totalConnections, activeStreams);

                // Build HTML
                let html = '<div class="connections-page" style="min-height: 100vh; color: #fff4e9; padding: 2rem 0; width: 100%; margin: 0 auto; position: relative; z-index: 1000;">';
                
                // Header with total count and Force Refresh button
                html += '<div style="margin-bottom: 30px;">';
                html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 15px;">';
                html += '<div style="flex: 1;">';
                html += '<h1 class="TypeGradient" style="margin-bottom: 10px; font-size: 1.5rem; margin-top:0 !important;">Core Connections</h1>';
                html += '<div class="connections-subtitle" style="color: #9A9793; font-size: 0.875rem; margin: 0;">' + totalConnections + ' ' + connectionLabel + '</div>';
                html += '</div>';
                html += '<button id="force-refresh-btn" class="force-refresh-btn" style="padding: 8px 16px; background: #2E2C2A50; border: 1px solid #5A575335; color: #9A9793; border-radius: 6px; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease; white-space: nowrap;" title="Refresh connections data">Force Refresh</button>';
                html += '</div>';
                
                // Search and View Toggle
                html += '<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">';
                html += '<div style="flex: 1; min-width: 300px;">';
                html += '<input type="text" id="connections-search" placeholder="Search connections..." style="width: 100%; padding: 10px 16px; opacity:.7; background: rgba(0,0,0,.1); border: 1px solid #1f1d1a; border-radius: 6px; color: #fff4e9; font-size: 0.875rem; outline: none;" />';
                html += '</div>';
                html += '<div style="display: flex; align-items: center; gap: 10px;">';
                html += '<span style="color: #9A9793; font-size: 0.875rem;">View:</span>';
                html += '<button id="view-block-btn" class="view-toggle-btn active" data-view="block" style="padding: 8px 16px; background: linear-gradient(270deg, #974C00 0%, #8D8C00 100%) !important;border: 1px solid #1E1D1B !important; color: #fff4e9 !important; border-radius: 6px; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease; background-size: cover !important; background-repeat: no-repeat !important;">Block</button>';
                html += '<button id="view-list-btn" class="view-toggle-btn" data-view="list" style="padding: 8px 16px; background: #2E2C2A50; border: 1px solid #5A575335; color: #9A9793; border-radius: 6px; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">List</button>';
                html += '</div>';
                html += '</div>';
                
                // Connections Container
                html += '<div id="connections-container" class="connections-block-view" style="display: grid; gap: 20px;">';
                
                if (connectedConnections.length === 0) {
                    html += '<div style="text-align: center; padding: 60px 20px; color: #9A9793;"><p>No connected connections found. Connect services in VL Hub Profile.</p></div>';
                } else {
                    connectedConnections.forEach((connection, index) => {
                        const connectionId = 'connection-' + index;
                        const safeName = escapeAttr(connection.name);
                        const safeDesc = escapeAttr(connection.desc);
                        // Store connection data as base64-encoded JSON to avoid HTML attribute issues
                        // Use UTF-8 safe base64 encoding to handle Unicode characters
                        let connectionDataJson = '';
                        try {
                            const jsonString = JSON.stringify(connection.data || {});
                            // Convert UTF-8 string to base64 safely
                            connectionDataJson = btoa(unescape(encodeURIComponent(jsonString)));
                        } catch (e) {
                            console.warn('[Connections] Error encoding connection data:', e);
                            // Fallback: use empty object if encoding fails
                            connectionDataJson = btoa(unescape(encodeURIComponent(JSON.stringify({}))));
                        }
                        // Store the connection type ID for fetching fresh data if needed
                        const connectionTypeId = connection.id;
                        
                        html += '<div class="connection-item" data-connection-name="' + safeName.toLowerCase() + '" data-connection-id="' + connection.id.toLowerCase() + '" data-connection-type="' + escapeAttr(connectionTypeId) + '" data-connection-data="' + connectionDataJson + '" style="background: #000000; border: 1px solid #1f1d1a; border-radius: 8px; padding: 20px; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.borderColor=\'#5A5753\';" onmouseout="this.style.borderColor=\'#2E2C2A\';">';
                        
                        // Block view layout
                        html += '<div class="connection-block" style="display: grid; grid-template-columns: 100px 1fr; gap: 0; align-items: center;">';
                        
                        // Icon/Image - using SVG img tag
                        html += '<div style="width: 80px; height: 80px; background: #000000; border-radius: 6px; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border: 1px solid #2E2C2A;">';
                        html += '<img src="' + escapeAttr(connection.icon || 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg') + '" alt="' + escapeAttr(connection.name) + ' icon" class="connection-icon" style="width: 40px; height: 40px; object-fit: contain;" />';
                        html += '</div>';
                        
                        // Connection Info
                        html += '<div class="connectionInfo" style="flex: 1;">';
                        html += '<h3 style="color: #fff4e9; margin: 0 0; font-size: 1rem;font-weight: 500; line-height:1rem;">' + safeName + '</h3>';
                        html += '<p style="color: #9A9793; margin: .25rem 0 .4rem; font-size: 0.875rem;">' + safeDesc + '</p>';
                        
                        // Status badge
                        html += '<div style="display: flex; gap: 10px; flex-wrap: wrap;">';
                        html += '<span style="padding: .15rem .4rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: #0F9900; color: #fff4e9;">Connected</span>';
                        html += '</div>';
                        
                        html += '</div>';
                        html += '</div>';
                        
                        // List view layout (hidden by default)
                        html += '<div class="connection-list" style="display: none; grid-template-columns: 80px 1fr auto; gap: 16px; align-items: center;">';
                        html += '<div style="width: 80px; height: 80px; background: #000000; border-radius: 6px; overflow: hidden; flex-shrink: 0; border: 1px solid #1f1d1a; display: flex; align-items: center; justify-content: center;">';
                        html += '<img src="' + escapeAttr(connection.icon || 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg') + '" alt="' + escapeAttr(connection.name) + ' icon" class="connection-icon" style="width: 40px; height: 40px; object-fit: contain;" />';
                        html += '</div>';
                        html += '<div style="flex: 1; min-width: 0;">';
                        html += '<h3 style="color: #fff4e9; margin: 0 0 4px 0; font-size: 1rem; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + safeName + '</h3>';
                        html += '<p style="color: #9A9793; margin: 0; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + safeDesc + '</p>';
                        html += '</div>';
                        html += '<div style="display: flex; gap: 8px; flex-direction: column;">';
                        html += '<span style="padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: #0F9900; color: #fff4e9;">Connected</span>';
                        html += '</div>';
                        html += '</div>';
                        
                        html += '</div>';
                    });
                }
                
                html += '</div>';
                html += '</div>';
                
                contentDiv.innerHTML = html;
                
                // Initialize search and view toggle
                const searchInput = document.getElementById('connections-search');
                const viewListBtn = document.getElementById('view-list-btn');
                const viewBlockBtn = document.getElementById('view-block-btn');
                const connectionsContainer = document.getElementById('connections-container');
                
                // Restore view state after rendering
                if (connectionsContainer) {
                    if (currentViewState === 'block') {
                        connectionsContainer.className = 'connections-block-view';
                        if (viewBlockBtn) viewBlockBtn.classList.add('active');
                        if (viewListBtn) viewListBtn.classList.remove('active');
                    } else {
                        connectionsContainer.className = 'connections-list-view';
                        if (viewListBtn) viewListBtn.classList.add('active');
                        if (viewBlockBtn) viewBlockBtn.classList.remove('active');
                    }
                }
                
                // Restore search term
                if (searchInput) {
                    searchInput.value = currentSearchTerm;
                    // Trigger input event to filter if there's a search term
                    if (currentSearchTerm) {
                        const event = new Event('input', { bubbles: true });
                        searchInput.dispatchEvent(event);
                    }
                }
                
                // Search functionality - use cloneNode to prevent duplicate listeners
                if (searchInput) {
                    // Remove old listeners by cloning
                    const newSearchInput = searchInput.cloneNode(true);
                    searchInput.parentNode.replaceChild(newSearchInput, searchInput);
                    
                    newSearchInput.addEventListener('input', function(e) {
                        window.connectionsSearchTerm = e.target.value.toLowerCase().trim();
                        const searchTerm = window.connectionsSearchTerm;
                        const connectionItems = document.querySelectorAll('.connection-item');
                        
                        connectionItems.forEach(item => {
                            const name = item.getAttribute('data-connection-name') || '';
                            const id = item.getAttribute('data-connection-id') || '';
                            
                            if (!searchTerm || name.includes(searchTerm) || id.includes(searchTerm)) {
                                item.style.display = '';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    });
                }

                // Add click handlers to connection items to show details popup
                const connectionItems = document.querySelectorAll('.connection-item');
                connectionItems.forEach(item => {
                    item.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const connectionId = item.getAttribute('data-connection-id');
                        const connectionName = item.getAttribute('data-connection-name');
                        const connectionDataJson = item.getAttribute('data-connection-data');
                        
                        // Decode base64 data (handle UTF-8 encoding)
                        let connectionData = null;
                        if (connectionDataJson) {
                            try {
                                // Decode base64 and handle UTF-8 characters
                                const decoded = decodeURIComponent(escape(atob(connectionDataJson)));
                                connectionData = JSON.parse(decoded);
                            } catch (error) {
                                console.error('[Connections] Error parsing connection data:', error);
                            }
                        }
                        
                        // Get connection type ID for fetching fresh data if needed
                        const connectionTypeId = item.getAttribute('data-connection-type');
                        
                        // If we have connection data, show it. Otherwise, fetch fresh data
                        if (connectionData) {
                            showConnectionDetails(connectionId, connectionName, connectionData);
                        } else if (connectionTypeId) {
                            // Fetch fresh data from API using the connection type ID
                            try {
                                const licenseKey = getLicenseKey();
                                if (licenseKey) {
                                    const response = await fetch(`https://visiblelight.ai/wp-json/vl-hub/v1/all-connections?license=${encodeURIComponent(licenseKey)}&_t=${Date.now()}`, {
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' },
                                        credentials: 'include'
                                    });
                                    
                                    if (response.ok) {
                                        const data = await response.json();
                                        const connectionsData = data?.ok && data?.data ? data.data : data;
                                        
                                        // Get the specific connection data using the connection type ID
                                        const specificData = connectionsData[connectionTypeId];
                                        
                                        if (specificData) {
                                            showConnectionDetails(connectionId, connectionName, specificData);
                                        } else {
                                            showConnectionDetails(connectionId, connectionName, { error: 'Connection data not found' });
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('[Connections] Error fetching connection data:', error);
                                showConnectionDetails(connectionId, connectionName, { error: 'Failed to load connection data' });
                            }
                        } else {
                            showConnectionDetails(connectionId, connectionName, { error: 'No connection data available' });
                        }
                    });
                });
                
                // View toggle functionality - use cloneNode to prevent duplicate listeners
                const newViewListBtn = document.getElementById('view-list-btn');
                const newViewBlockBtn = document.getElementById('view-block-btn');
                const newConnectionsContainer = document.getElementById('connections-container');
                
                if (newViewListBtn && newViewBlockBtn && newConnectionsContainer) {
                    // Remove old listeners by cloning
                    const clonedListBtn = newViewListBtn.cloneNode(true);
                    const clonedBlockBtn = newViewBlockBtn.cloneNode(true);
                    newViewListBtn.parentNode.replaceChild(clonedListBtn, newViewListBtn);
                    newViewBlockBtn.parentNode.replaceChild(clonedBlockBtn, newViewBlockBtn);
                    
                    // Restore active state on cloned buttons
                    if (currentViewState === 'block') {
                        clonedBlockBtn.classList.add('active');
                        clonedListBtn.classList.remove('active');
                    } else {
                        clonedListBtn.classList.add('active');
                        clonedBlockBtn.classList.remove('active');
                    }
                    
                    clonedBlockBtn.addEventListener('click', function() {
                        window.connectionsViewState = 'block';
                        newConnectionsContainer.className = 'connections-block-view';
                        clonedBlockBtn.classList.add('active');
                        clonedListBtn.classList.remove('active');
                    });
                    
                    clonedListBtn.addEventListener('click', function() {
                        window.connectionsViewState = 'list';
                        newConnectionsContainer.className = 'connections-list-view';
                        clonedListBtn.classList.add('active');
                        clonedBlockBtn.classList.remove('active');
                    });
                }

                // Set up Force Refresh button
                const forceRefreshBtn = document.getElementById('force-refresh-btn');
                if (forceRefreshBtn) {
                    // Remove any existing listeners by cloning
                    const clonedBtn = forceRefreshBtn.cloneNode(true);
                    forceRefreshBtn.parentNode.replaceChild(clonedBtn, forceRefreshBtn);
                    
                    clonedBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        if (!canForceRefresh()) {
                            return; // Button should be disabled, but just in case
                        }
                        
                        // Update cooldown timestamp
                        localStorage.setItem(FORCE_REFRESH_STORAGE_KEY, Date.now().toString());
                        
                        // Update button state immediately
                        updateForceRefreshButton();
                        
                        // Refresh connections data (this will preserve view state)
                        console.log('[Connections] Force refreshing connections...');
                        await renderConnections();
                    });
                    
                    // Update button state on render
                    updateForceRefreshButton();
                }
                
                // Set up interval to update button state every minute (only once globally)
                if (!window.forceRefreshButtonInterval) {
                    window.forceRefreshButtonInterval = setInterval(updateForceRefreshButton, 60000);
                }

            } catch (error) {
                console.error('[Connections] Error rendering:', error);
                contentDiv.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #9A9793;"><h1 style="color: #fff4e9;">Error</h1><p>Failed to load connections: ' + error.message + '</p></div>';
            }
        }

        // Initialize on page load (no auto-refresh - manual refresh only via button)
        document.addEventListener('DOMContentLoaded', async () => {
            // Render connections on page load (no automatic refresh to prevent interference)
            await renderConnections();
        });

        // Also render immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', async () => {
                await renderConnections();
            });
        } else {
            (async () => {
                await renderConnections();
            })();
        }
    </script>

    <!-- Include shared JavaScript from index.html for menu navigation, dropdown, etc. -->
    <script>
        // Minimal shared functionality - menu navigation
        const SUPERCLUSTER_BASE_URL = 'https://supercluster.visiblelight.ai';
        const LOGIN_PAGE_URL = 'https://visiblelight.ai/auth/';

        // Get license key from URL
        function getLicenseKey() {
            const urlParams = new URLSearchParams(window.location.search);
            let licenseKey = urlParams.get('license') || '';
            if (licenseKey) {
                const licenseMatch = licenseKey.match(/^([^/]+)/);
                if (licenseMatch) {
                    licenseKey = licenseMatch[1];
                }
            }
            return licenseKey;
        }

        // Setup menu navigation
        function setupMenuNavigation() {
            const menuItems = document.querySelectorAll('.vl-main-menu a');
            const PATH_MAP = {
                'luna-compose': 'luna-compose/',
                'luna-report': 'luna-reports/',
                'luna-automate': 'workflows/automations/',
                'luna-connect': 'connections/'
            };

            menuItems.forEach((item) => {
                const section = item.getAttribute('data-section');
                const path = item.getAttribute('data-path');
                
                if (section === 'supercluster') {
                    const licenseKey = getLicenseKey();
                    if (licenseKey) {
                        item.href = `${SUPERCLUSTER_BASE_URL}/?license=${encodeURIComponent(licenseKey)}`;
                    }
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const currentLicenseKey = getLicenseKey();
                        if (currentLicenseKey) {
                            window.location.href = `${SUPERCLUSTER_BASE_URL}/?license=${encodeURIComponent(currentLicenseKey)}`;
                        }
                    }, true);
                } else if (path) {
                    const licenseKey = getLicenseKey();
                    const targetPath = PATH_MAP[path] || `${path}/`;
                    if (licenseKey) {
                        item.href = `${SUPERCLUSTER_BASE_URL}/?license=${encodeURIComponent(licenseKey)}/${targetPath}`;
                    }
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const currentLicenseKey = getLicenseKey();
                        if (currentLicenseKey) {
                            const targetPath = PATH_MAP[path] || `${path}/`;
                            window.location.href = `${SUPERCLUSTER_BASE_URL}/?license=${encodeURIComponent(currentLicenseKey)}/${targetPath}`;
                        } else {
                            window.location.href = LOGIN_PAGE_URL;
                        }
                    }, true);
                }
            });
        }

        // Setup connection status
        function setupConnectionStatus() {
            const connectionIcon = document.getElementById('connectionIcon');
            const connectionStatus = document.getElementById('connectionStatus');
            
            async function checkConnectionStatus() {
                try {
                    const licenseKey = getLicenseKey();
                    if (!licenseKey) {
                        updateConnectionStatus(false, 'No license key');
                        return;
                    }
                    
                    const endpoint = 'https://visiblelight.ai/wp-json/vl-hub/v1/constellation';
                    const url = `${endpoint}?license=${encodeURIComponent(licenseKey)}`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const isConnected = response.ok;
                    updateConnectionStatus(isConnected, isConnected ? null : `HTTP ${response.status}`);
                } catch (error) {
                    console.error('Connection check failed:', error);
                    updateConnectionStatus(false, error.message);
                }
            }
            
            function updateConnectionStatus(isConnected, error = null) {
                const checkmarkUrl = 'https://visiblelight.ai/wp-content/uploads/2025/10/checkmark.svg';
                const xIconUrl = 'https://visiblelight.ai/wp-content/uploads/2025/10/x-close-icon.svg';
                
                if (isConnected) {
                    if (connectionIcon) {
                        const iconImg = connectionIcon.querySelector('img');
                        if (iconImg) {
                            iconImg.src = checkmarkUrl;
                            iconImg.alt = 'check mark';
                        }
                    }
                    if (connectionStatus) {
                        connectionStatus.textContent = 'Active';
                    }
                } else {
                    if (connectionIcon) {
                        const iconImg = connectionIcon.querySelector('img');
                        if (iconImg) {
                            iconImg.src = xIconUrl;
                            iconImg.alt = 'error mark';
                        }
                    }
                    if (connectionStatus) {
                        connectionStatus.textContent = 'Inactive';
                    }
                }
            }
            
            checkConnectionStatus();
            // REMOVED: Hourly connection status check to prevent interference with Luna Composer
        }

        // Update license key display
        function updateLicenseKeyDisplay() {
            const licenseKey = getLicenseKey();
            const licenseKeyEl = document.getElementById('licenseKeyDisplay');
            const copyBtn = document.getElementById('copyLicenseBtn');
            
            if (licenseKeyEl) {
                if (licenseKey) {
                    const prefix = licenseKey.startsWith('VL-') ? 'VL-' : 'VL-';
                    const firstFourChars = licenseKey.substring(licenseKey.indexOf('-') + 1, licenseKey.indexOf('-') + 5);
                    const blurredText = '<span class="blurred-text">-XXXX</span>';
                    licenseKeyEl.innerHTML = prefix + firstFourChars + blurredText;
                    
                    if (copyBtn) {
                        copyBtn.onclick = async function() {
                            try {
                                await navigator.clipboard.writeText(licenseKey);
                                const originalHTML = copyBtn.innerHTML;
                                copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalHTML;
                                }, 2000);
                            } catch (err) {
                                const textArea = document.createElement('textarea');
                                textArea.value = licenseKey;
                                document.body.appendChild(textArea);
                                textArea.select();
                                document.execCommand('copy');
                                document.body.removeChild(textArea);
                            }
                        };
                    }
                } else {
                    licenseKeyEl.textContent = 'No license key';
                }
            }
        }

        // Setup client dropdown
        function setupClientDropdown() {
            const dropdownArrow = document.getElementById('clientDropdownArrow');
            const dropdownLightbox = document.getElementById('clientDropdownLightbox');
            const dropdownContent = document.getElementById('clientDropdownContent');
            const logoutOption = document.getElementById('logoutOption');
            const logoutModal = document.getElementById('logoutModal');
            const logoutCancel = document.getElementById('logoutCancel');
            const logoutConfirm = document.getElementById('logoutConfirm');
            
            if (!dropdownArrow || !dropdownLightbox || !dropdownContent) {
                return;
            }
            
            if (dropdownLightbox.dataset.initialized === 'true') {
                return;
            }
            dropdownLightbox.dataset.initialized = 'true';
            
            function positionDropdown() {
                dropdownContent.style.top = '60px';
                dropdownContent.style.right = '20px';
            }
            
            function toggleDropdown() {
                const isVisible = dropdownLightbox.style.display === 'block';
                if (isVisible) {
                    dropdownLightbox.style.display = 'none';
                    dropdownLightbox.style.pointerEvents = 'none';
                } else {
                    positionDropdown();
                    dropdownLightbox.style.display = 'block';
                    dropdownLightbox.style.pointerEvents = 'auto';
                }
            }
            
            function closeDropdown() {
                dropdownLightbox.style.display = 'none';
                dropdownLightbox.style.pointerEvents = 'none';
            }
            
            function showLogoutModal() {
                if (logoutModal) logoutModal.style.display = 'block';
            }
            
            function hideLogoutModal() {
                if (logoutModal) logoutModal.style.display = 'none';
            }
            
            function performLogout() {
                localStorage.removeItem('vl-cms-data');
                localStorage.removeItem('vl-supercluster-tutorial-completed');
                sessionStorage.clear();
                window.location.href = LOGIN_PAGE_URL;
            }
            
            dropdownArrow.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleDropdown();
            }, true);
            
            dropdownLightbox.addEventListener('click', function(e) {
                if (!dropdownContent.contains(e.target)) {
                    closeDropdown();
                }
            });
            
            dropdownContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && dropdownLightbox.style.display === 'block') {
                    closeDropdown();
                }
            });
            
            if (logoutOption) {
                logoutOption.onclick = function(e) {
                    e.preventDefault();
                    closeDropdown();
                    showLogoutModal();
                };
            }
            
            if (logoutCancel) {
                logoutCancel.onclick = hideLogoutModal;
            }
            
            if (logoutConfirm) {
                logoutConfirm.onclick = performLogout;
            }
        }

        // Get timezone-based greeting
        function getTimezoneGreeting() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour >= 5 && hour < 12) {
                return 'Good morning,';
            } else if (hour >= 12 && hour < 17) {
                return 'Good afternoon,';
            } else if (hour >= 17 && hour < 22) {
                return 'Good evening,';
            } else {
                return 'Welcome,';
            }
        }

        // Update dynamic greeting
        function updateDynamicGreeting() {
            const greetingEl = document.getElementById('dynamicGreeting');
            if (greetingEl) {
                greetingEl.textContent = getTimezoneGreeting();
            }
        }

        // Update client name
        async function updateClientName() {
            const clientNameEl = document.getElementById('clientName');
            if (!clientNameEl) return;
            
            try {
                const licenseKey = getLicenseKey();
                if (!licenseKey) {
                    clientNameEl.textContent = 'Client';
                    updateDynamicGreeting();
                    return;
                }
                
                const sessionUrl = `https://visiblelight.ai/wp-json/vl-hub/v1/session?license=${encodeURIComponent(licenseKey)}`;
                const sessionResponse = await fetch(sessionUrl, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (sessionResponse.ok) {
                    const sessionData = await sessionResponse.json();
                    if (sessionData && sessionData.license && sessionData.license.client_name) {
                        clientNameEl.textContent = sessionData.license.client_name;
                        updateDynamicGreeting();
                        return;
                    }
                }
                
                const connectionsUrl = `https://visiblelight.ai/wp-json/vl-hub/v1/all-connections?license=${encodeURIComponent(licenseKey)}`;
                const connectionsResponse = await fetch(connectionsUrl, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (connectionsResponse.ok) {
                    const connectionsData = await connectionsResponse.json();
                    if (connectionsData && connectionsData.license && connectionsData.license.client_name) {
                        clientNameEl.textContent = connectionsData.license.client_name;
                        updateDynamicGreeting();
                        return;
                    }
                }
            } catch (error) {
                console.error('Error updating client name:', error);
            }
            updateDynamicGreeting();
        }

        // Format connection data for human-friendly display (similar to Display View in VL Hub)
        function formatConnectionData(data, indent = 0, keyName = '') {
            const indentPx = indent * 24;
            const isRoot = indent === 0;
            
            if (data === null || data === undefined) {
                return '<span style="color: #9A9793; font-style: italic;">null</span>';
            }
            
            if (typeof data === 'string') {
                // Format long strings with word break
                const displayValue = data.length > 100 ? data.substring(0, 100) + '...' : data;
                return '<span style="color: #fff4e9; word-break: break-word;">"' + escapeAttr(displayValue) + '"</span>';
            }
            
            if (typeof data === 'number') {
                // Format large numbers with commas
                const formatted = data.toLocaleString();
                return '<span style="color: #8D8C00; font-weight: 500;">' + formatted + '</span>';
            }
            
            if (typeof data === 'boolean') {
                return '<span style="color: ' + (data ? '#0F9900' : '#f85149') + '; font-weight: 500;">' + (data ? 'true' : 'false') + '</span>';
            }
            
            if (Array.isArray(data)) {
                if (data.length === 0) {
                    return '<span style="color: #9A9793;">[] (empty)</span>';
                }
                let html = '<div style="margin-left: ' + indentPx + 'px; margin-top: 8px;">';
                html += '<div style="color: #9A9793; margin-bottom: 4px;">Array (' + data.length + ' items):</div>';
                data.forEach((item, index) => {
                    html += '<div style="margin-left: 20px; margin-bottom: 12px; padding: 8px; background: rgba(46, 44, 42, 0.3); border-left: 2px solid #2e2c2a; border-radius: 4px;">';
                    html += '<span style="color: #974C00; font-weight: 500; font-size: 0.8rem;">[' + index + ']</span> ';
                    html += formatConnectionData(item, indent + 1);
                    html += '</div>';
                });
                html += '</div>';
                return html;
            }
            
            if (typeof data === 'object') {
                const keys = Object.keys(data);
                if (keys.length === 0) {
                    return '<span style="color: #9A9793;">{} (empty object)</span>';
                }
                let html = '<div style="margin-left: ' + (isRoot ? '0' : indentPx) + 'px; margin-top: ' + (isRoot ? '0' : '8px') + ';">';
                if (!isRoot) {
                    html += '<div style="color: #9A9793; margin-bottom: 4px; font-size: 0.85rem;">Object (' + keys.length + ' properties):</div>';
                }
                keys.forEach((key, index) => {
                    const value = data[key];
                    const isComplex = typeof value === 'object' && value !== null;
                    html += '<div style="margin-left: ' + (isRoot ? '0' : '20') + 'px; margin-bottom: ' + (isComplex ? '12px' : '8px') + '; padding: ' + (isComplex ? '12px' : '8px') + '; background: ' + (isComplex ? 'rgba(46, 44, 42, 0.3)' : 'rgba(46, 44, 42, 0.15)') + '; border-left: 2px solid #2e2c2a; border-radius: 4px;">';
                    html += '<div style="display: flex; align-items: flex-start; gap: 8px;">';
                    html += '<span style="color: #974C00; font-weight: 600; min-width: 150px; font-size: 0.9rem;">' + escapeAttr(key) + ':</span>';
                    html += '<div style="flex: 1;">' + formatConnectionData(value, indent + 1, key) + '</div>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
                return html;
            }
            
            return '<span style="color: #9A9793;">' + escapeAttr(String(data)) + '</span>';
        }

        // Show connection details popup
        function showConnectionDetails(connectionId, connectionName, connectionData) {
            const modal = document.getElementById('connectionDetailsModal');
            const modalTitle = document.getElementById('connectionModalTitle');
            const modalContent = document.getElementById('connectionModalContent');
            const closeBtn = document.getElementById('closeConnectionModal');
            
            if (!modal || !modalTitle || !modalContent) return;
            
            // Set title
            const displayName = connectionName.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            modalTitle.textContent = displayName + ' Connection Details';
            
            // Format and display data
            modalContent.innerHTML = formatConnectionData(connectionData);
            
            // Show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Close button handler
            if (closeBtn) {
                closeBtn.onclick = function() {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                };
            }
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            };
            
            // Close on Escape key
            const escapeHandler = function(e) {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Generate Luna connections insights using GPT-4o
        async function generateLunaConnectionsInsights(connectedConnections, totalConnections, activeStreams) {
            const insightsEl = document.getElementById('lunaConnectionsSummary');
            if (!insightsEl) return;

            // Get GPT-4o key from luna-widget endpoint
            let gptApiKey = null;
            try {
                const licenseKey = getLicenseKey();
                if (licenseKey) {
                    // Try to get GPT key from luna-widget endpoint
                    // First, get client site URL from profile
                    const profileUrl = `https://visiblelight.ai/wp-json/vl-hub/v1/profile?license=${encodeURIComponent(licenseKey)}`;
                    const profileResponse = await fetch(profileUrl, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();
                        let clientSiteUrl = null;
                        
                        // Extract client site URL
                        if (profileData.data?.site_info?.site) {
                            clientSiteUrl = profileData.data.site_info.site;
                        } else if (profileData.site_info?.site) {
                            clientSiteUrl = profileData.site_info.site;
                        } else if (profileData.site?.home_url) {
                            clientSiteUrl = profileData.site.home_url;
                        } else if (profileData.home_url) {
                            clientSiteUrl = profileData.home_url;
                        } else if (profileData.site && typeof profileData.site === 'string') {
                            clientSiteUrl = profileData.site;
                        }
                        
                        // Get GPT key from profile data (config endpoint doesn't exist, removed to prevent 404 errors)
                        // Fallback: Check profile data for GPT key
                        if (!gptApiKey) {
                            if (profileData.data?.gpt_api_key) {
                                gptApiKey = profileData.data.gpt_api_key;
                            } else if (profileData.gpt_api_key) {
                                gptApiKey = profileData.gpt_api_key;
                            } else if (profileData.data?.openai_api_key) {
                                gptApiKey = profileData.data.openai_api_key;
                            } else if (profileData.openai_api_key) {
                                gptApiKey = profileData.openai_api_key;
                            }
                        }
                    }
                }
                
                // Also check if widget has exposed the key globally
                if (!gptApiKey) {
                    if (window.lunaWidgetConfig && window.lunaWidgetConfig.openaiApiKey) {
                        gptApiKey = window.lunaWidgetConfig.openaiApiKey;
                    } else if (window.luna && window.luna.apiKey) {
                        gptApiKey = window.luna.apiKey;
                    }
                }
            } catch (error) {
                console.warn('[Insights] Could not retrieve GPT API key:', error);
            }

            // If we have GPT key, use it to generate intelligent insights
            if (gptApiKey) {
                try {
                    const connectionNames = connectedConnections.map(c => c.name).join(', ');
                    const connectionDescriptions = connectedConnections.map(c => `${c.name}: ${c.desc}`).join('; ');
                    const topConnection = connectedConnections.length > 0 ? connectedConnections[0] : null;
                    
                    const prompt = `You're helping a business owner understand their data connections in Visible Light. 

Context:
- ${totalConnections} active connections: ${connectionNames}
- ${activeStreams} active data streams flowing
- Top connection: ${topConnection ? `${topConnection.name} (${topConnection.desc})` : 'N/A'}

Write a brief, conversational insight (under 300 characters) that:
1. Opens warmly about their data harmonization progress
2. Explains how ${topConnection ? topConnection.name : 'their connections'} feeds AI worker agents with real-time data
3. Shows how this data harmonization trains AI to automate tasks and drive business growth
4. Ends with a practical tip on optimizing connections for AI training

Mix the actual data (${totalConnections} connections, ${activeStreams} streams) naturally into the conversation. Be human, not robotic. Focus on business value and AI training benefits.`;

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${gptApiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are a helpful AI assistant that provides concise, conversational business insights about data connections and AI training. Always stay under 300 characters.'
                                },
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            max_tokens: 150,
                            temperature: 0.8
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.choices && data.choices[0] && data.choices[0].message) {
                            const aiInsight = data.choices[0].message.content.trim();
                            // Ensure it's under 300 characters
                            const finalInsight = aiInsight.length > 300 ? aiInsight.substring(0, 297) + '...' : aiInsight;
                            insightsEl.innerHTML = '<p style="margin: 0; color: #9A9793; font-size: 0.875rem; line-height: 1.5;">' + finalInsight + '</p>';
                            return;
                        }
                    }
                } catch (error) {
                    console.error('[Insights] Error calling GPT-4o API:', error);
                    // Fall through to template-based insights
                }
            }

            // Fallback to template-based insights if GPT is unavailable

            // Human-friendly opening variations
            const openings = [
                'Your connections are harmonizing beautifully.',
                'Great work unifying your data sources.',
                'Your data ecosystem is taking shape.',
                'Excellent progress connecting your tools.'
            ];

            // Educational insights about data harmonization and AI training
            const aiTrainingInsights = [
                'Each connection feeds AI worker agents with real-time data, enabling smarter automation.',
                'Harmonized data trains AI agents to make better decisions, accelerating your growth.',
                'These streams power AI learning, helping agents understand your business patterns.',
                'Connected data creates a knowledge base for AI agents to optimize workflows.',
                'Your unified data helps AI agents learn customer behavior and market trends.',
                'Streams train AI to predict needs and automate tasks, saving you time.'
            ];

            // Connection-specific educational insights
            const connectionInsights = {
                'cloudflare': [
                    'Cloudflare data helps AI understand traffic patterns and security threats.',
                    'Cloudflare metrics train AI to optimize CDN performance automatically.',
                    'Security data from Cloudflare teaches AI to detect and prevent attacks.'
                ],
                'ssl_tls': [
                    'SSL data helps AI monitor certificate health and prevent downtime.',
                    'Certificate metrics train AI to automate security compliance.',
                    'SSL insights enable AI to predict and prevent certificate issues.'
                ],
                'liquidweb': [
                    'Hosting data trains AI to optimize server performance and costs.',
                    'Infrastructure metrics help AI predict capacity needs and scale resources.',
                    'Server data enables AI to automate maintenance and prevent outages.'
                ],
                'aws_s3': [
                    'Storage analytics train AI to optimize costs and improve access patterns.',
                    'S3 data helps AI automate backup strategies and data lifecycle management.',
                    'Cloud storage metrics enable AI to predict storage needs and optimize usage.'
                ],
                'ga4': [
                    'Analytics data trains AI to understand user behavior and optimize conversions.',
                    'GA4 insights help AI personalize experiences and predict customer actions.',
                    'User behavior data enables AI to automate marketing decisions and campaigns.'
                ],
                'gsc': [
                    'Search data trains AI to optimize content for better rankings.',
                    'GSC metrics help AI identify content gaps and opportunities.',
                    'SEO insights enable AI to automate content strategy and keyword targeting.'
                ],
                'competitor_reports': [
                    'Competitive data trains AI to identify market opportunities and threats.',
                    'Market insights help AI recommend strategies to outperform competitors.',
                    'Competitor analysis enables AI to automate competitive intelligence gathering.'
                ],
                'vldr_metrics': [
                    'Domain data trains AI to monitor reputation and brand health.',
                    'VLDR metrics help AI predict domain performance and optimize strategies.',
                    'Reputation insights enable AI to automate brand protection and growth.'
                ],
                'wordpress_users': [
                    'User data trains AI to personalize experiences and improve engagement.',
                    'Account metrics help AI automate user management and security.',
                    'User insights enable AI to predict churn and optimize retention strategies.'
                ],
                'wordpress_content': [
                    'Content data trains AI to optimize publishing schedules and topics.',
                    'Post metrics help AI identify high-performing content and replicate success.',
                    'Content insights enable AI to automate content creation and distribution.'
                ]
            };

            // Business growth and optimization conclusions
            const growthConclusions = [
                'More connections = smarter AI agents = faster business growth.',
                'Expand your network to unlock AI-powered automation and insights.',
                'Each new connection strengthens your AI training data and capabilities.',
                'Optimize streams to train more effective AI agents for your business.'
            ];

            // Randomly select variations
            const opening = openings[Math.floor(Math.random() * openings.length)];
            const aiInsight = aiTrainingInsights[Math.floor(Math.random() * aiTrainingInsights.length)];
            const conclusion = growthConclusions[Math.floor(Math.random() * growthConclusions.length)];

            // Build insight text - prioritize AI training education
            let insightText = opening + ' ';
            
            // Add connection-specific insight (limit to 1 connection to stay under 300 chars)
            if (connectedConnections.length > 0) {
                const conn = connectedConnections[0];
                const insights = connectionInsights[conn.id] || [conn.name + ' data trains AI agents.'];
                const insight = insights[Math.floor(Math.random() * insights.length)];
                insightText += insight + ' ';
            }

            // Add AI training insight
            insightText += aiInsight + ' ';
            
            // Add conclusion
            insightText += conclusion;

            // Ensure it's under 300 characters (strict limit)
            if (insightText.length > 300) {
                // Prioritize keeping the opening, one connection insight, and conclusion
                // Trim the AI insight if needed
                const parts = [
                    opening,
                    connectedConnections.length > 0 ? (connectionInsights[connectedConnections[0].id] || [''])[0] : '',
                    conclusion
                ].filter(p => p);
                
                let trimmed = parts.join(' ');
                if (trimmed.length > 300) {
                    // More aggressive trimming
                    const words = trimmed.split(' ');
                    trimmed = '';
                    for (let i = 0; i < words.length; i++) {
                        const testText = trimmed + (trimmed ? ' ' : '') + words[i];
                        if (testText.length <= 295) {
                            trimmed = testText;
                        } else {
                            break;
                        }
                    }
                }
                insightText = trimmed.trim();
            }

            insightsEl.innerHTML = '<p style="margin: 0; color: #9A9793; font-size: 0.875rem; line-height: 1.5;">' + insightText + '</p>';
        }

        // Initialize Luna launcher skeleton
        function initLunaLauncherSkeleton() {
            try {
                const container = document.getElementById('vlLunaChatContainer');
                if (!container) return;
                // Don't overwrite if widget or launcher already rendered
                if (container.querySelector('.luna-launcher')) return;

                // Inject minimal styles for loading spinner once
                if (!document.getElementById('luna-launcher-loading-styles')) {
                    const style = document.createElement('style');
                    style.id = 'luna-launcher-loading-styles';
                    style.textContent = `
.luna-launcher.luna-launcher--loading {
  position: fixed;
  bottom: 25px;
  right: 25px;
  z-index: 2147483645;
  background: #000000;
  border: 1px solid #1f1d1a;
  border-radius: 999px;
  padding: 6px 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: default;
  opacity: 0.9;
}
.luna-launcher.luna-launcher--loading .ava {
  width: 28px;
  height: 28px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #2e2c2a;
}
.luna-launcher.luna-launcher--loading .ava .spinner {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid rgba(255,244,233,0.2);
  border-top-color: #fff4e9;
  animation: luna-spinner 0.9s linear infinite;
}
.luna-launcher.luna-launcher--loading .label {
  color: #000;
  font-size: 0.85rem;
  font-weight: 500;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
}
@keyframes luna-spinner {
  to { transform: rotate(360deg); }
}
`;
                    document.head.appendChild(style);
                }

                container.innerHTML = '<button class="luna-launcher luna-launcher--loading" type="button" aria-label="Luna is loading"><span class="ava"><span class="spinner"></span></span><span class="label">Luna is loading…</span></span></button>';
            } catch (e) {
                console.error('[Luna Widget] Error initializing launcher skeleton:', e);
            }
        }

        // Load Luna widget
        async function checkAndLoadLunaWidget() {
            console.log('[Luna Widget] Starting widget load check...');
            const container = document.getElementById('vlLunaChatContainer');
            if (!container) {
                console.error('[Luna Widget] Container not found: vlLunaChatContainer');
                return;
            }
            console.log('[Luna Widget] Container found:', container);

            try {
                // Get license key from URL
                let licenseKey = getLicenseKey();
                
                console.log('[Luna Widget] License key:', licenseKey);
                
                if (!licenseKey) {
                    console.warn('[Luna Widget] No license key found, skipping widget load');
                    return;
                }

                // Validate license key by checking all-connections endpoint
                console.log('[Luna Widget] Validating license key...');
                const validationUrl = `https://visiblelight.ai/wp-json/vl-hub/v1/all-connections?license=${encodeURIComponent(licenseKey)}`;
                const validationResponse = await fetch(validationUrl, {
                    method: 'GET',
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!validationResponse.ok) {
                    console.warn('[Luna Widget] License key validation failed:', validationResponse.status);
                    return;
                }
                
                const validationData = await validationResponse.json();
                if (!validationData || !validationData.ok) {
                    console.warn('[Luna Widget] License key is not valid or active');
                    return;
                }
                
                console.log('[Luna Widget] License key validated successfully');

                // Get client profile data from VL Hub API to get the client site URL
                const profileUrl = `https://visiblelight.ai/wp-json/vl-hub/v1/profile?license=${encodeURIComponent(licenseKey)}`;
                console.log('[Luna Widget] Fetching profile from:', profileUrl);
                
                const profileResponse = await fetch(profileUrl, {
                    method: 'GET',
                    credentials: 'include',
                    mode: 'cors'
                });
                
                console.log('[Luna Widget] Profile response status:', profileResponse.status);
                
                if (!profileResponse.ok) {
                    const errorText = await profileResponse.text();
                    console.error('[Luna Widget] Failed to fetch profile:', profileResponse.status, errorText);
                    return;
                }
                
                const profileData = await profileResponse.json();
                console.log('[Luna Widget] Profile data received:', profileData);
                
                // Check if profile data is valid
                if (!profileData || (!profileData.ok && !profileData.license_key && !profileData.site)) {
                    console.error('[Luna Widget] Invalid profile data:', profileData);
                    return;
                }

                // Get client site URL from profile - check multiple possible locations
                let clientSiteUrl = null;
                if (profileData.data?.site_info?.site) {
                    clientSiteUrl = profileData.data.site_info.site;
                } else if (profileData.site_info?.site) {
                    clientSiteUrl = profileData.site_info.site;
                } else if (profileData.site?.home_url) {
                    clientSiteUrl = profileData.site.home_url;
                } else if (profileData.home_url) {
                    clientSiteUrl = profileData.home_url;
                } else if (profileData.site) {
                    clientSiteUrl = typeof profileData.site === 'string' ? profileData.site : profileData.site.home_url;
                }
                
                console.log('[Luna Widget] Client site URL:', clientSiteUrl);
                
                if (!clientSiteUrl) {
                    console.error('[Luna Widget] No client site URL found in profile');
                    return;
                }

                // Fetch the widget HTML/CSS/JS from the client's WordPress site with vl_key parameter
                const widgetHtmlUrl = `${clientSiteUrl.replace(/\/$/, '')}/wp-json/luna_widget/v1/widget/html?vl_key=${encodeURIComponent(licenseKey)}`;
                
                console.log('[Luna Widget] Fetching widget from:', widgetHtmlUrl);
                
                try {
                    const widgetResponse = await fetch(widgetHtmlUrl, {
                        method: 'GET',
                        credentials: 'include',
                        mode: 'cors'
                    });
                    
                    console.log('[Luna Widget] Widget response status:', widgetResponse.status);
                    
                    if (widgetResponse.ok) {
                        const widgetData = await widgetResponse.json();
                        console.log('[Luna Widget] Widget data received:', widgetData);
                        
                        if (widgetData.ok && widgetData.html) {
                            console.log('[Luna Widget] Injecting widget HTML/CSS/JS...');
                            
                            // Inject CSS first
                            if (widgetData.css) {
                                const style = document.createElement('style');
                                style.id = 'luna-widget-embed-styles';
                                style.textContent = widgetData.css;
                                // Remove existing styles if present
                                const existing = document.getElementById('luna-widget-embed-styles');
                                if (existing) existing.remove();
                                document.head.appendChild(style);
                                console.log('[Luna Widget] CSS injected');
                            }
                            
                            // Inject HTML - position in bottom right corner
                            container.innerHTML = widgetData.html;
                            container.style.position = 'fixed';
                            container.style.bottom = '20px';
                            container.style.right = '20px';
                            container.style.zIndex = '2147483646';
                            console.log('[Luna Widget] HTML injected into container');
                            
                            // Inject JavaScript after a short delay to ensure DOM is ready
                            if (widgetData.js) {
                                setTimeout(function() {
                                    const script = document.createElement('script');
                                    script.id = 'luna-widget-embed-script';
                                    // Remove existing script if present
                                    const existing = document.getElementById('luna-widget-embed-script');
                                    if (existing) existing.remove();
                                    script.textContent = widgetData.js;
                                    document.body.appendChild(script);
                                    console.log('[Luna Widget] Widget loaded successfully');
                                }, 100);
                            } else {
                                console.warn('[Luna Widget] Widget HTML loaded, but no JavaScript provided');
                            }
                            return;
                        } else if (widgetData.error) {
                            console.error('[Luna Widget] Widget not available:', widgetData.error);
                            return;
                        } else {
                            console.error('[Luna Widget] Widget data missing ok or html:', widgetData);
                            return;
                        }
                    } else {
                        // Handle non-OK responses gracefully
                        let errorText = '';
                        try {
                            errorText = await widgetResponse.text();
                        } catch (textError) {
                            errorText = 'Unable to read error response';
                        }
                        console.error('[Luna Widget] Failed to fetch widget:', widgetResponse.status, errorText);
                        // Don't show error to user, just log it - widget may not be available for this client
                        return;
                    }
                } catch (e) {
                    // Handle network errors gracefully (CORS, network failures, etc.)
                    console.error('[Luna Widget] Could not fetch widget HTML:', e);
                    // Don't show error to user - widget may not be available or CORS may be blocking
                    // The widget will simply not load, which is acceptable
                    return;
                }
                
            } catch (error) {
                console.error('[Luna Widget] Error loading widget:', error);
            }
        }

        // Initialize widget toggle functionality
        function initWidgetToggle() {
            const toggleButtons = document.querySelectorAll('.vl-widget-toggle');
            
            toggleButtons.forEach(function(button) {
                // Skip if already initialized
                if (button.dataset.initialized === 'true') return;
                button.dataset.initialized = 'true';
                
                const widgetId = button.getAttribute('data-widget');
                const widget = document.getElementById(widgetId);
                if (!widget) return;
                
                const widgetBody = widget.querySelector('.vl-widget-body');
                if (!widgetBody) return;
                
                // Get or create the icon element
                let icon = button.querySelector('.vl-toggle-icon');
                if (!icon) {
                    icon = document.createElement('img');
                    icon.className = 'vl-toggle-icon';
                    button.appendChild(icon);
                }
                
                // Set initial state based on whether widget body is hidden
                const isHidden = widgetBody.classList.contains('vl-widget-body-hidden');
                if (isHidden) {
                    // Widget is hidden, show "Show" state
                    icon.src = 'https://visiblelight.ai/wp-content/uploads/2025/11/vl-eye-icon.svg';
                    icon.alt = 'Show';
                    button.setAttribute('aria-label', 'Show widget');
                } else {
                    // Widget is visible, show "Hide" state
                    icon.src = 'https://visiblelight.ai/wp-content/uploads/2025/11/vl-eye-hide-icon.svg';
                    icon.alt = 'Hide';
                    button.setAttribute('aria-label', 'Hide widget');
                }
                
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const widgetId = button.getAttribute('data-widget');
                    const widget = document.getElementById(widgetId);
                    if (!widget) return;
                    
                    const widgetBody = widget.querySelector('.vl-widget-body');
                    if (!widgetBody) return;
                    
                    const isHidden = widgetBody.classList.contains('vl-widget-body-hidden');
                    
                    // Get or create the icon element
                    let icon = button.querySelector('.vl-toggle-icon');
                    if (!icon) {
                        icon = document.createElement('img');
                        icon.className = 'vl-toggle-icon';
                        button.appendChild(icon);
                    }
                    
                    if (isHidden) {
                        // Show the widget body
                        widgetBody.classList.remove('vl-widget-body-hidden');
                        icon.src = 'https://visiblelight.ai/wp-content/uploads/2025/11/vl-eye-hide-icon.svg';
                        icon.alt = 'Hide';
                        button.setAttribute('aria-label', 'Hide widget');
                    } else {
                        // Hide the widget body
                        widgetBody.classList.add('vl-widget-body-hidden');
                        icon.src = 'https://visiblelight.ai/wp-content/uploads/2025/11/vl-eye-icon.svg';
                        icon.alt = 'Show';
                        button.setAttribute('aria-label', 'Show widget');
                    }
                });
            });
        }

        // Show avatar initials with gradient background
        function showAvatarInitials(avatarEl, clientName) {
            avatarEl.innerHTML = '';
            avatarEl.style.background = 'linear-gradient(90deg, #974C00 0%, #8D8C00 100%)';
            avatarEl.style.color = '#fff4e9';
            avatarEl.style.display = 'flex';
            avatarEl.style.alignItems = 'center';
            avatarEl.style.justifyContent = 'center';
            avatarEl.style.fontWeight = '600';
            avatarEl.style.fontSize = '0.75rem';
            avatarEl.style.textTransform = 'uppercase';
            avatarEl.style.letterSpacing = '0.05em';
            
            // Extract initials from client name
            const words = clientName.trim().split(/\s+/);
            let initials = '';
            if (words.length >= 2) {
                initials = words[0].charAt(0) + words[words.length - 1].charAt(0);
            } else if (words.length === 1) {
                initials = words[0].substring(0, 2).toUpperCase();
            } else {
                initials = 'CL';
            }
            
            avatarEl.textContent = initials.toUpperCase();
        }

        // Show avatar image
        function showAvatarImage(avatarEl, imageUrl) {
            avatarEl.innerHTML = '';
            avatarEl.style.background = 'transparent';
            avatarEl.style.display = 'flex';
            avatarEl.style.alignItems = 'center';
            avatarEl.style.justifyContent = 'center';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'Client Avatar';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '40px';
            img.onerror = function() {
                // If image fails to load, show initials instead
                const clientNameEl = document.getElementById('clientName');
                const clientName = clientNameEl ? clientNameEl.textContent.trim() : 'Client';
                showAvatarInitials(avatarEl, clientName);
            };
            avatarEl.appendChild(img);
        }

        // Extract og:image from site data
        function extractOgImage(site) {
            if (!site || typeof site !== 'object') return null;

            const candidates = [];
            const pushCandidate = (candidate) => {
                if (typeof candidate === 'string') {
                    const trimmed = candidate.trim();
                    if (trimmed !== '') {
                        candidates.push(trimmed);
                    }
                }
            };

            pushCandidate(site.og_image);
            pushCandidate(site.ogImage);
            pushCandidate(site.og_image_url);
            pushCandidate(site.ogImageUrl);
            pushCandidate(site.open_graph_image);
            pushCandidate(site.openGraphImage);
            pushCandidate(site.opengraph_image);
            pushCandidate(site.social_image);
            pushCandidate(site.socialImage);
            pushCandidate(site.image);
            pushCandidate(site.preview_image);
            pushCandidate(site.screenshot);

            if (site.opengraph && typeof site.opengraph === 'object') {
                pushCandidate(site.opengraph.image);
                pushCandidate(site.opengraph.og_image);
                if (Array.isArray(site.opengraph.images)) {
                    pushCandidate(site.opengraph.images[0]);
                }
            }

            if (site.social && typeof site.social === 'object') {
                pushCandidate(site.social.image);
                if (site.social.opengraph && typeof site.social.opengraph === 'object') {
                    pushCandidate(site.social.opengraph.image);
                }
            }

            if (site.meta && typeof site.meta === 'object') {
                pushCandidate(site.meta.og_image);
                pushCandidate(site.meta.ogImage);
            }

            if (site.meta_tags && typeof site.meta_tags === 'object') {
                pushCandidate(site.meta_tags['og:image']);
                pushCandidate(site.meta_tags['og_image']);
            }

            const unique = candidates.filter((value, index, array) => array.indexOf(value) === index);
            return unique.length > 0 ? unique[0] : null;
        }

        // Update client avatar
        async function updateClientAvatar() {
            const avatarEl = document.getElementById('clientAvatar');
            if (!avatarEl) return;

            try {
                // Get license key
                const licenseKey = getLicenseKey();
                const clientNameEl = document.getElementById('clientName');
                const clientName = clientNameEl ? clientNameEl.textContent.trim() : '';

                if (!licenseKey) {
                    // No license, show default initials
                    showAvatarInitials(avatarEl, clientName || 'Client');
                    return;
                }

                // Try to get client site URL from profile
                let clientSiteUrl = null;
                try {
                    const profileUrl = `https://visiblelight.ai/wp-json/vl-hub/v1/profile?license=${encodeURIComponent(licenseKey)}`;
                    const profileResponse = await fetch(profileUrl, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();
                        // Try multiple possible locations for site URL
                        if (profileData.data?.site_info?.site) {
                            clientSiteUrl = profileData.data.site_info.site;
                        } else if (profileData.site_info?.site) {
                            clientSiteUrl = profileData.site_info.site;
                        } else if (profileData.site?.home_url) {
                            clientSiteUrl = profileData.site.home_url;
                        } else if (profileData.home_url) {
                            clientSiteUrl = profileData.home_url;
                        } else if (profileData.site && typeof profileData.site === 'string') {
                            clientSiteUrl = profileData.site;
                        }
                    }
                } catch (e) {
                    console.warn('[Client Avatar] Could not fetch profile:', e);
                }

                // If we have a site URL, try to fetch og:image
                if (clientSiteUrl) {
                    try {
                        // Try to get og:image from client sites endpoint
                        const sitesUrl = `https://visiblelight.ai/wp-json/vl-hub/v1/client-sites?license=${encodeURIComponent(licenseKey)}`;
                        const sitesResponse = await fetch(sitesUrl, {
                            method: 'GET',
                            credentials: 'include'
                        });

                        if (sitesResponse.ok) {
                            const sitesData = await sitesResponse.json();
                            if (sitesData && sitesData.sites && Array.isArray(sitesData.sites) && sitesData.sites.length > 0) {
                                // Find the site matching our clientSiteUrl
                                const matchingSite = sitesData.sites.find(site => {
                                    const siteUrl = site.url || site.home_url || '';
                                    return siteUrl.toLowerCase().replace(/\/$/, '') === clientSiteUrl.toLowerCase().replace(/\/$/, '');
                                }) || sitesData.sites[0]; // Fallback to first site

                                // Try to extract og:image from site data
                                const ogImage = extractOgImage(matchingSite);
                                
                                if (ogImage) {
                                    // Show og:image
                                    showAvatarImage(avatarEl, ogImage);
                                    return;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('[Client Avatar] Could not fetch client sites:', e);
                    }
                }

                // No og:image found, show initials
                showAvatarInitials(avatarEl, clientName || 'Client');
            } catch (error) {
                console.error('[Client Avatar] Error updating avatar:', error);
                // Fallback to initials on error
                const clientNameEl = document.getElementById('clientName');
                const clientName = clientNameEl ? clientNameEl.textContent.trim() : 'Client';
                showAvatarInitials(avatarEl, clientName);
            }
        }

        // Initialize all functionality
        function initializeConnectionsPage() {
            setupMenuNavigation();
            setupConnectionStatus();
            setupClientDropdown();
            updateLicenseKeyDisplay();
            updateDynamicGreeting(); // Update greeting immediately
            updateClientName();
            updateClientAvatar(); // Add avatar update
            initWidgetToggle(); // Add widget toggle
            initLunaLauncherSkeleton(); // Ensure Luna launcher is visible
            // Load Luna widget after skeleton is shown
            setTimeout(() => {
                checkAndLoadLunaWidget();
            }, 500);
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeConnectionsPage);
        } else {
            initializeConnectionsPage();
        }
    </script>
</body>
</html>

